---
title: æ¯å‘¨æ—¥ç»ƒä¹ 
date: 2021-09-17 16:27:28
tags:
---
### URAL2118

> ç»™å®šå‰ $k$ ä¸ªå­—æ¯çš„ $01$ å‰ç¼€ç¼–ç ï¼ˆä¸å­˜åœ¨ä¸€ä¸ªç¼–ç æ˜¯å¦ä¸€ä¸ªç¼–ç çš„å‰ç¼€ï¼‰ã€‚
>
> ç»™å®šå­—ç¬¦ä¸² $s$ï¼Œè®¾å…¶è§£ç åçš„ $01$ ä¸²ä¸º $S$ï¼Œæ±‚æœ€å¤šèƒ½å°† $S$ åˆ’åˆ†ä¸ºå¤šå°‘æ®µä½¿å¾—æ¯ä¸€æ®µéƒ½æ— æ³•è§£ç ï¼Œæ— è§£è¾“å‡º $-1$ã€‚
>
> $k \le 52, n\le 10^6$

é¦–å…ˆè€ƒè™‘ä¸¤ç§ç‰¹æ®Šæƒ…å†µï¼š

- ç¼–ç ä¸­æ—¢æœ‰ $0$ï¼Œä¹Ÿæœ‰ $1$ï¼Œé‚£ $S$ æ— è®ºæ€ä¹ˆåˆ’åˆ†éƒ½å¯ä»¥è§£ç ã€‚
- ç¼–ç ä¸­æ—¢æ²¡ $0$ï¼Œä¹Ÿæ²¡ $1$ï¼Œé‚£ä¹ˆç­”æ¡ˆä¸º $|S|$ã€‚

å‰©ä¸‹çš„æƒ…å†µä¸ºï¼šæœ‰ $0$ æ—  $1$ å’Œæœ‰ $1$ æ—  $0$ï¼Œç”±äºå¯¹ç§°æ€§ï¼Œåªè€ƒè™‘æœ‰ $0$ æ—  $1$ã€‚

é¦–å…ˆç­”æ¡ˆçš„ä¸Šç•Œä¸º $1$ çš„ä¸ªæ•°ï¼Œå› ä¸ºå…¨ $0$ çš„ä¸€æ®µæ˜¯å¯ä»¥è¢«è§£ç çš„ã€‚

å¦‚æœæœ€åä¸€ä½ä¸º $1$ï¼Œé‚£ä¹ˆåœ¨æ¯ä¸ª $1$ åé¢æ–­å¼€ï¼Œå°±å¯ä»¥å–åˆ°è¿™ä¸ªä¸Šç•Œã€‚

å¦‚æœæœ€åä¸€ä½ä¸º $0$ï¼Œå‡è®¾æœ€åä¸€æ®µ $T$ï¼Œå¯ä»¥è¯´æ˜å­˜åœ¨æœ€ä¼˜è§£æ»¡è¶³ $T$ å‰é¢æ˜¯ $1$ï¼šå‡è®¾ $T$ å‰é¢æœ‰ **è¿ç»­** çš„ $x$ ä¸ª $0$ï¼Œå‰é¢æ€»å…±æœ‰ $y$ ä¸ª $1$ã€‚é‚£ä¹ˆç­”æ¡ˆçš„ä¸Šç•Œä¸º $y+1$ï¼ŒæŠŠè¿™ $x$ ä¸ª $0$ åŠ å…¥ $T$ï¼Œç„¶ååœ¨ $T$ å‰é¢çš„æ¯ä¸ª $1$ åé¢æ–­å¼€å°±å¯ä»¥åˆ°è¾¾è¿™ä¸ªä¸Šç•Œã€‚

å¦‚æœ $T$ å‰é¢æœ‰ $y$ ä¸ª $1$ï¼Œæœ€å¤§æ®µæ•°å°±æ˜¯ $y+1$ï¼Œé—®é¢˜å°±æ˜¯æ±‚æœ€å¤§çš„ $y$ï¼Œå‡è®¾ $T'$ æ˜¯æœ€çŸ­çš„æ— æ³•è¢«è§£ç çš„åç¼€ï¼Œå¯ä»¥è¯´æ˜æœ€å¤§çš„ $y$ ç­‰äº $T'$ å‰é¢ $1$ çš„ä¸ªæ•°ï¼šç”±äº $|T|\ge |T'|$ï¼Œæ‰€ä»¥ $y$ ä¸ä¼šè¶…è¿‡ $T'$ å‰é¢ $1$ çš„ä¸ªæ•°ï¼Œå¦å¤–ï¼Œä»¤ $T=T'å‰é¢æé•¿çš„ä¸€æ®µ0+T'$ï¼Œ$y$ å°±å¯ä»¥å–åˆ°è¿™ä¸ªä¸Šç•Œã€‚

é—®é¢˜è½¬åŒ–æˆäº†æ±‚ $T'$ï¼Œé‚£ä¹ˆ $T'$ çš„ä»»ä½•å‰ç¼€éƒ½æ— æ³•è§£ç ï¼Œå¦åˆ™ $T'$ ä¸æ˜¯æœ€çŸ­çš„ï¼Œè®° $suffix(i)$ è¡¨ç¤º $S$ é•¿åº¦ä¸º $i$ çš„åç¼€ï¼Œé—®é¢˜å°±æ˜¯ä¾æ¬¡åˆ¤æ–­ $suffix(1),suffix(2),suffix(3),\cdots$ æ˜¯å¦æœ‰å‰ç¼€å¯ä»¥è¢«è§£ç ï¼Œ`AC` è‡ªåŠ¨æœºå³å¯ã€‚

å¤æ‚åº¦ $O(nk)$ã€‚

### Graph Subpaths

> æ²¡æœ‰æäº¤åœ°å€ã€‚
>
> ç»™å®šä¸€å¼  $n$ ä¸ªç‚¹ $m$ æ¡è¾¹çš„æœ‰å‘æ— ç¯å›¾ï¼Œå†ç»™å®š $k$ æ¡è·¯å¾„ï¼Œæ¯æ¡è·¯å¾„é•¿åº¦ä¸º $l_i$ï¼Œä¸€æ¡åˆæ³•è·¯å¾„ä¸åŒ…å«è¿™ $k$ æ¡è·¯å¾„ã€‚
>
> å¯¹äº $i \in [2,n]$ï¼Œæ±‚ $1\rightarrow i$ çš„åˆæ³•è·¯å¾„æ¡æ•°ã€‚
>
> $n,m,\sum_{i=1}^kl_i \le 10^5$

### Sol 1

é¦–å…ˆæŠŠæ‰€æœ‰è¾¹åå‘ï¼Œå°±è½¬åŒ–æˆäº†æ±‚ $i\rightarrow 1$ çš„åˆæ³•è·¯å¾„æ¡æ•°ã€‚

å¯¹äºè¾¹ $(u,v)$ï¼Œæ ‡è®°å®ƒçš„æƒå€¼ä¸º $v$ï¼Œè®¾ $T_i$ è¡¨ç¤º $i\rightarrow 1$ æ‰€æœ‰åˆæ³•è·¯å¾„ç»„æˆçš„ `trie`ï¼Œè€ƒè™‘æ€ä¹ˆæŒ‰æ‹“æ‰‘åºæ±‚å‡ºæ¯ä¸€ä¸ª $T_u$ï¼Œå¯¹äºè¾¹ $(u,v)$ï¼Œ$T_v$ æ˜¯å·²ç»æ±‚è¿‡äº†ï¼ŒæŠŠ $T_v$ å¤åˆ¶åˆ°æ ¹çš„å„¿å­ï¼Œä½†è¿™æ ·ä¼šæœ‰ä¸€äº›ä»¥ $u$ ä¸ºèµ·ç‚¹çš„ä¸åˆæ³•è·¯å¾„ï¼Œéœ€è¦åˆ é™¤è¿™äº›è·¯å¾„ï¼šä» $T_u$ çš„æ ¹å‡ºå‘æ²¿ç€ä¸åˆæ³•è·¯å¾„èµ°ï¼ŒæŠŠä»¥ç»ˆç‚¹ä¸ºæ ¹çš„å­æ ‘åˆ é™¤å³å¯ã€‚$u$ çš„ç­”æ¡ˆå°±æ˜¯ $T_u$ çš„å¶å­ä¸ªæ•°ã€‚

ç”±äº $T_u$ éå¸¸å¤§ï¼Œå½“ç„¶ä¸èƒ½ç›´æ¥å­˜ä¸‹æ¥ï¼Œå¯è¡Œçš„æ–¹æ³•æ˜¯ç”¨å¯æŒä¹…åŒ–çš„ `trie`ï¼Œå¯¹äºè¾¹ $(u,v)$ï¼Œåªéœ€è¦ä» $T_u$ çš„æ ¹å‘ $T_v$ è¿ä¸€æ¡è¾¹å°±è¡Œäº†ï¼Œè€Œä¸ç”¨å¤åˆ¶æ•´æ£µ $T_v$ï¼Œåˆ é™¤å­æ ‘ä¹Ÿåªéœ€è¦å¯¹è·¯å¾„ä¸Šçš„ç»“ç‚¹å»ºæ–°ç‰ˆæœ¬ã€‚

ä¸€ä¸ªé—®é¢˜æ˜¯å„¿å­åˆ—è¡¨çš„ç»´æŠ¤ï¼Œå¦‚æœç”¨é“¾è¡¨ç»´æŠ¤çš„è¯ï¼Œåˆ é™¤å­æ ‘æ—¶æ–°å»ºçš„ç»“ç‚¹éœ€è¦ä»åŸç‰ˆæœ¬å¤åˆ¶æ•´ä¸ªé“¾è¡¨ï¼Œå¤æ‚åº¦å¯èƒ½è¾¾åˆ° $O(n^2)$ã€‚

ç”¨ä¸»å¸­æ ‘ç»´æŠ¤å„¿å­åˆ—è¡¨å°±å¯ä»¥ $O(n\log n)$ åœ°æ–°å»ºç»“ç‚¹ã€‚

å¤æ‚åº¦ $O(n\log n)$ã€‚

### Sol 2

å¯¹æ‰€æœ‰è·¯å¾„å»º `AC` è‡ªåŠ¨æœºï¼Œä¸éš¾æƒ³åˆ°ä¸€ä¸ª $O(n^2)$ çŠ¶æ€çš„ `DP`ï¼Œè®¾ $f_{i,u}$ è¡¨ç¤ºåœ¨åŸå›¾ä¸­èµ°åˆ° $i$ï¼Œ`AC` è‡ªåŠ¨æœºä¸Šèµ°åˆ° `u`ï¼Œä¸”æ²¡æœ‰ç»è¿‡ `AC` è‡ªåŠ¨æœºä¸Šç»ˆæ­¢ç»“ç‚¹çš„è·¯å¾„æ¡æ•°ã€‚

ç”±äº `AC` è‡ªåŠ¨æœºä¸Šçš„ç‚¹å¯¹åº”å”¯ä¸€åŸå›¾ä¸­çš„ç‚¹çš„ï¼Œæ‰€ä»¥ `DP` çŠ¶æ€å®šä¹‰æˆ $f_u$ å°±å¯ä»¥è½¬ç§»äº†ã€‚

ç”±äºå»º `AC` è‡ªåŠ¨æœºéœ€è¦ä¸»å¸­æ ‘ï¼Œå¤æ‚åº¦ $O(n\log n)$ã€‚

### ZOJ3390

> å¯¹äºä¸¤æ£µæ ‘ $T_1,T_2$ï¼Œå®šä¹‰ $T_1+T_2$ è¡¨ç¤ºæŠŠæ ¹åˆå¹¶ï¼Œ$T_1\cdot T_2$ è¡¨ç¤ºæŠŠ $T_1$ ä¸­æ¯ä¸ªç»“ç‚¹æ¢æˆ $T_2$ï¼Œ$T_1=T_2$ è¡¨ç¤ºæ ‘åŒæ„ã€‚
>
> ç»™å®šæ ‘ $A,B,C$ï¼Œæ±‚ $X,Y$ æ»¡è¶³ $AX+BY=C$ã€‚
>
> $|A|,|B|,|C| \le 10^5$

è®¾ $height(T)$ è¡¨ç¤º $T$ çš„æ ‘é«˜ï¼ˆæœ€æ·±å¶å­åˆ°æ ¹çš„è·ç¦»ï¼‰ã€‚

å¯ä»¥å‘ç° $height(T_1+T_2)=\max(height(T_1),height(T_2)),height(T_1\cdot T_2)=height(T_1)+height(T_2)$ã€‚

é‚£ä¹ˆ $\max(height(A)+height(X),height(B)+height(Y))=height(C)$ï¼Œå‡è®¾ $height(A)+height(X)=height(C)$ï¼ˆå¦ä¸€ç§æƒ…å†µæ˜¯ä¸€æ ·çš„ï¼‰ã€‚

è¿™æ ·å°±çŸ¥é“äº† $height(X)$ï¼Œè€ƒè™‘æ€ä¹ˆæ±‚ $X$ï¼Œå¾ˆç®€å•ï¼Œå‡è®¾ $u$ ä¸º $C$ ä¸­æœ€æ·±å¶å­çš„ $height(X)$ çº§ç¥–å…ˆï¼Œä»¥ $u$ ä¸ºæ ¹çš„å­æ ‘å°±æ˜¯ $X$ï¼Œè¿™æ ·å°±çŸ¥é“äº† $AX$ï¼Œç„¶åå°±å¯ä»¥æ±‚å‡º $BY$ï¼Œå†ç”¨ç±»ä¼¼çš„æ–¹æ³•å°±å¯ä»¥æ±‚å‡º $Y$ äº†ã€‚

è™½ç„¶æ€è·¯å¾ˆç®€å•ï¼Œä½†æ˜¯æœ‰ä¸€å®šå®ç°éš¾åº¦ï¼Œæ±‚ $BY$ æ—¶æ ‘çš„â€œå‡æ³•â€œï¼Œä»¥åŠåˆ¤å®šç­”æ¡ˆæ˜¯å¦åˆæ³•éƒ½éœ€è¦ç”¨åˆ°æ ‘å“ˆå¸Œã€‚

æ ‘å“ˆå¸Œå…¬å¼ï¼š
$$
f_u=1+\sum_{v\in son(u)}f_v\cdot \text{prime}(size_v)
$$
å…¶ä¸­ $\text{prime}(i)$ è¡¨ç¤ºç¬¬ $i$ ä¸ªè´¨æ•°ã€‚

**æ³¨ï¼š**å¯¹äºä¸¤æ£µå¤§å°ä¸åŒçš„æ ‘ $T_1,T_2$ï¼Œ$f_{T_1}=f_{T_2}$ æ˜¯å¯èƒ½çš„ï¼Œå› æ­¤å“ˆå¸Œåº”å½“å’Œå­æ ‘å¤§å°æ†ç»‘åœ¨ä¸€èµ·ã€‚

`Generator` ï¼šå‚æ•° $T,A,B,C,D$ å¯è°ƒï¼Œåˆ†åˆ«è¡¨ç¤ºæ•°æ®ç»„æ•°å’Œæ ‘ $A,X,B,Y$ çš„å¤§å°ã€‚

<details><summary><span style="font-size: large; font-weight: bold; color: rgb(33,150,243);">²é¿´´úÂë</span></summary>
```cpp
#include <bits/stdc++.h>
#define rep(i, l, r) for(int i = (l); i <= (r); i++)
#define per(i, r, l) for(int i = (r); i >= (l); i--)
#define mem(a, b) memset(a, b, sizeof a)
#define For(i, l, r) for(int i = (l), i##e = (r); i < i##e; i++)
#define pb push_back
#define eb emplace_back
#define mp make_pair
#define fi first 
#define se second
#define all(x) (x).begin(), (x).end()
#define SZ(x) int((x).size())
#define mid ((l + r) / 2)
#define lc o * 2
#define rc o * 2 + 1
#define lch l, mid, lc
#define rch mid + 1, r, rc
#define cmi(a, b) (a = min(a, b))
#define cma(a, b) (a = max(a, b))
#define lb lower_bound
#define ub upper_bound
#define bs binary_search
#define pop __builtin_popcount
#define llpop __builtin_popcountll
#define ctz __builtin_ctz
#define llctz __builtin_ctzll
#define clz __builtin_clz
#define llclz __builtin_clzll
#define par __builtin_parity
#define llpar __builtin_parityll

using namespace std;
using ll = long long;
using lf = double;
// using P = pair<int, int>;
using V = vector<int>;
// using cmp = complex<lf>;

ll gen(ll x) {
    const ll k = 0x9ddfea08eb382d69ull;
    rep(i, 1, 3) x *= k, x ^= x >> 47;
    return x * k;
}
int rnd() {
    static ll s = time(0) + (ll)new char;
    return (s += gen(s)) & INT_MAX;
}
V tmul(V a, V b) {
    int n = a.size() - 1, m = b.size() - 1, su = n;
    rep(i, 1, n) {
        rep(j, 2, m) a.pb(b[j] == 1 ? i : b[j] + su - 1);
        su += m - 1;
    }
    return a;
}
V tplus(V a, V b) {
    int n = a.size() - 1, m = b.size() - 1;
    rep(j, 2, m) a.pb(b[j] == 1 ? 1 : b[j] + n - 1);
    return a;
}
const int N = 5, A = 5, B = 5, C = 5, D = 5;
int main() {
    const int T = 100000;
    printf("%d\n", T);
    rep(kase, 1, T) {
        int a = rnd() % A + 1, b = rnd() % B + 1, c = rnd() % C + 1, d = rnd() % D + 1;
        V t1{0}, t2{0}, t3{0}, t4{0};
        auto get = [](V& t, int n) { rep(i, 1, n) t.pb(i > 1 ? rnd() % (i - 1) + 1 : 0); };
        get(t1, a), get(t2, b), get(t3, c), get(t4, d);
        V t5 = tplus(tmul(t1, t2), tmul(t3, t4));
        printf("%d %d %llu\n", a, c, t5.size() - 1);
        auto prt = [](V& v) { For(i, 1, v.size()) printf("%d ", v[i]); puts(""); };
        prt(t1), prt(t3), prt(t5);
    }
}
```
</details>

`Special judge`ï¼šå‡è®¾ä¿å­˜ä¸º `checker.cpp`ï¼Œç¼–è¯‘ååœ¨å‘½ä»¤è¡Œä¸­ä½¿ç”¨ï¼š`checker <input-file> <output-file>`ï¼Œç­”æ¡ˆæ­£ç¡®è¿”å›å€¼ä¸º $0$ï¼Œå¦åˆ™è¿”å›å€¼ä¸º $1$ï¼Œè¾“å‡ºä¸ºç¬¬ä¸€ç»„å‡ºé”™çš„æ•°æ®ã€‚

<details><summary><span style="font-size: large; font-weight: bold; color: rgb(33,150,243);">²é¿´´úÂë</span></summary>
```cpp
#include <bits/stdc++.h>
#define rep(i, l, r) for(int i = (l); i <= (r); i++)
#define per(i, r, l) for(int i = (r); i >= (l); i--)
#define mem(a, b) memset(a, b, sizeof a)
#define For(i, l, r) for(int i = (l), i##e = (r); i < i##e; i++)
#define pb push_back
#define eb emplace_back
#define mp make_pair
#define fi first 
#define se second
#define all(x) (x).begin(), (x).end()
#define SZ(x) int((x).size())
#define mid ((l + r) / 2)
#define lc o * 2
#define rc o * 2 + 1
#define lch l, mid, lc
#define rch mid + 1, r, rc
#define cmi(a, b) (a = min(a, b))
#define cma(a, b) (a = max(a, b))
#define lb lower_bound
#define ub upper_bound
#define bs binary_search
#define pop __builtin_popcount
#define llpop __builtin_popcountll
#define ctz __builtin_ctz
#define llctz __builtin_ctzll
#define clz __builtin_clz
#define llclz __builtin_clzll
#define par __builtin_parity
#define llpar __builtin_parityll

using namespace std;
using ll = long long;
using lf = double;
using P = pair<int, int>;
using V = vector<int>;
// using cmp = complex<lf>;

const int N = 1e5 + 5, M = 1299709;
int f[M + 5], pid, prm[N];

V tmul(V a, V b) {
    int n = a.size() - 1, m = b.size() - 1, su = n;
    rep(i, 1, n) {
        rep(j, 2, m) a.pb(b[j] == 1 ? i : b[j] + su - 1);
        su += m - 1;
    }
    return a;
}
V tplus(V a, V b) {
    int n = a.size() - 1, m = b.size() - 1;
    rep(j, 2, m) a.pb(b[j] == 1 ? 1 : b[j] + n - 1);
    return a;
}

P dfs(int u, const V G[]) {
    P re(1, 1);
    for(int v : G[u]) {
        auto [h, sz] = dfs(v, G);
        re.fi = (re.fi + (ll)h * prm[sz]) % 999999937;
        re.se += sz;
    }
    return re;
}
int Hash(const V& t) {
    vector<int> G[N];
    For(i, 1, t.size()) G[t[i]].pb(i);
    return dfs(1, G).fi;
}
int read(FILE* f) { int x; return fscanf(f, "%d", &x) == 1 ? x : -1; }

int main(int argc, char* argv[]) {
    rep(i, 2, M) {
        if(!f[i]) prm[++pid] = i;
        for(int j = 1; i * prm[j] <= M; j++) {
            f[i * prm[j]] = 1;
            if(i % prm[j] == 0) break;
        }
    }
    FILE *in = fopen(argv[1], "r"), *out = fopen(argv[2], "r");
    for(int T = read(in); T--;) {
        V t1{0}, t2{0}, t3{0}, t4{0}, t5{0};
        auto get = [](FILE* f, V& t, int n) { rep(i, 1, n) t.pb(read(f)); };
        int a = read(in), b = read(in), c = read(in);
        get(in, t1, a), get(in, t3, b), get(in, t5, c);
        int d = read(out), e = read(out);
        auto err = [&]() {
            printf("1\n%d %d %d\n", a, b, c);
            rep(i, 1, a) printf("%d ", t1[i]); puts("");
            rep(i, 1, b) printf("%d ", t3[i]); puts("");
            rep(i, 1, c) printf("%d ", t5[i]);
            exit(1);
        };
        if(!~d) err();
        get(out, t2, d), get(out, t4, e);
        if((ll)a * d + (ll)b * e != c && Hash(tplus(tmul(t1, t2), tmul(t3, t4))) != Hash(t5)) err();
    }
}
```
</details>

### IZhO 2020 D1T3

> [é¢˜ç›®é“¾æ¥](codeforces.com/group/Uo1lq8ZyWf/contest/265564)
>
> ç»™å®šé•¿åº¦ä¸º $n$ çš„åºåˆ— $A$ï¼Œé—®æœ‰å¤šå°‘ä¸‰å…ƒç»„ $(i,j,k)$ æ»¡è¶³ $i\le j<k$ ä¸” $[i,j]$ å’Œ $[j+1,k]$ ä¸¤ä¸ªåŒºé—´ä¸­æ•°çš„é›†åˆç›¸åŒã€‚
>
> $n \le 2\cdot 10^5$

è®° $prev_i$ è¡¨ç¤º $A_i$ ä¸Šä¸€æ¬¡å‡ºç°çš„ä½ç½®ï¼Œ$next_i$ è¡¨ç¤º $A_i$ ä¸‹ä¸€æ¬¡å‡ºç°çš„ä½ç½®ã€‚

ä¸‰å…ƒç»„ $(i,j,k)$ åˆæ³•çš„å……è¦æ¡ä»¶ä¸ºï¼š

- åŒºé—´ $[j+1,k]$ ä¸­çš„æ•°éƒ½åœ¨ $[i,j]$ ä¸­å‡ºç°ï¼Œå³ $i \le \min prev_{j+1\cdots i}$ï¼Œç›¸å½“äº $i$ æœ‰ä¸ªä¸Šç•Œ $R_{j,k}=\min prev_{j+1\cdots k}$ã€‚
- åŒºé—´ $[i,j]$ ä¸­çš„æ•°éƒ½åœ¨ $[j+1,k]$ ä¸­å‡ºç°ï¼Œå³ $\max next_{i\cdots j}\le k$ï¼Œç›¸å½“äº $i$ æœ‰ä¸ªä¸‹ç•Œ $L_{j,k}$ï¼Œå…¶ä¸­ $L_{j,k}$ æ˜¯æœ€å°çš„ $i$ æ»¡è¶³ $\max next_{i\cdots j}\le k$ã€‚

é‚£ä¹ˆ $(j,k)$ çš„è´¡çŒ®å°±æ˜¯ $\max(R_{j,k}-L_{j,k}+1,0)$ï¼Œè€ƒè™‘åªæšä¸¾ $k$ï¼Œç”¨æ•°æ®ç»“æ„åŠ¨æ€ç»´æŠ¤ $\sum_{j=1}^{k-1}\max(R_{j,k}-L_{j,k}+1,0)$ã€‚

å…ˆè€ƒè™‘ $L_{j,k}$ å’Œ $R_{j,k}$ åˆ†åˆ«æ€ä¹ˆç»´æŠ¤ã€‚

å¯¹äº $R_{j,k}=\min prev_{j+1\cdots k}$ï¼Œè¿™æ˜¯ $prev$ æ•°ç»„ä¸Šçš„åç¼€ $\min$ï¼Œå½“ $k\rightarrow k+1$ æ—¶ï¼Œ$R_{j,k}$ å‘ç”Ÿçš„æ”¹å˜æ˜¯ä¸€ä¸ªåç¼€å˜æˆäº† $prev_{k+1}$ï¼Œå…·ä½“å¯ä»¥ç”¨å•è°ƒæ ˆæ±‚å‡ºè¿™ä¸ªåç¼€ï¼Œç„¶ååŒºé—´èµ‹å€¼ã€‚

å¯¹äº $L_{j,k}$ï¼Œç›´æ¥åˆ†æ $k\rightarrow k+1$ ä¸å¤ªè¡Œï¼Œæ¢ä¸€ä¸ªè§’åº¦è€ƒè™‘å¯¹äºä¸€ä¸ª $j$ï¼Œ$L_{j,k}$ å’Œ $k$ çš„å…³ç³»ï¼Œ$\max next_{i\cdots j}$ æ˜¯ $next$ æ•°ç»„ä¸Šçš„åç¼€ $\max$ï¼Œå°† $next_{1\cdots j}$ ä¾æ¬¡æ’å…¥å•è°ƒæ ˆï¼Œè®¾å•è°ƒæ ˆä¸­å…ƒç´ åˆ†åˆ«ä¸º $next_{i_1},next_{i_2},next_{i_3},\cdots,next_{i_k}$ï¼š

- å½“ $k\in[j+1,next_{i_k}-1]$ æ—¶ï¼Œ$L_{j,k}=\infty$ã€‚
- å½“ $k\in [next_{i_k},next_{i_{k-1}-1}]$ï¼Œ$L_{j,k}=i_{k-1}+1$ã€‚
- $\cdots$
- å½“ $k\in [next_{i_1},n]$ï¼Œ$L_{j,k}=1$ã€‚

ç»¼ä¸Šï¼Œå•è°ƒæ ˆå…ƒç´  $i_x$ æ„å‘³ç€å½“ $k\in [next_{i_x},next_{i_{x-1}}-1]$ï¼Œ$L_{j,k}=i_{x-1}+1$ï¼Œå‡è®¾æ’å…¥ $next_y$ å $next_{i_x}$ è¢«å¼¹æ‰äº†ï¼Œé‚£ä¹ˆå½“ $j\in [i_x,y-1],k\in [next_{i_x},next_{i_{x-1}}-1]$ æ—¶ï¼Œ$L_{j,k}=i_{x-1}+1$ï¼Œç›¸å½“äº $k$ ä» $next_{i_x}-1\rightarrow next_{i_x}$ æ—¶ï¼Œå¯¹ $L_{i_x\cdots y-1,k}$ è¿›è¡ŒåŒºé—´èµ‹å€¼ä¸º 
$i_x+1$ã€‚æ¯ä¸ªå•è°ƒæ ˆå…ƒç´ æ„å‘³ç€ä¸€æ¬¡åŒºé—´èµ‹å€¼ï¼Œæ‰€ä»¥åªéœ€è¦ $n$ æ¬¡åŒºé—´èµ‹å€¼å°±å¯ä»¥ç»´æŠ¤ $L_{j,k}$ã€‚

ä½†ç»´æŠ¤çš„æ˜¯ $\sum_{j=1}^{k-1}\max(R_{j,k}-L_{j,k}+1,0)$ï¼Œç›¸å½“äºå¤¹åœ¨ä¸¤æ¡é€’å¢æŠ˜çº¿ä¹‹é—´çš„é¢ç§¯ã€‚ç”±äº $L_{j,k}$ å’Œ $R_{j,k}$ éƒ½æ˜¯éšç€ $k$ å¢å¤§è€Œå‡å°çš„ï¼Œæ‰€ä»¥æ¯æ¬¡èµ‹å€¼éƒ½æ˜¯å‡å°ã€‚æ¯”å¦‚å°† $R_{l\cdots r,k}$ æ”¹ä¸º $v$ï¼Œå¦‚æœ $v \le \min L_{l\cdots r,k}$ï¼Œè¿™ä¸€æ®µçš„é¢ç§¯å°±æ˜¯ $0$ï¼Œå¦‚æœ $v \ge \max L_{l\cdots r,k}$ï¼Œè¿™ä¸€æ®µçš„é¢ç§¯å°±æ˜¯ $\sum_{j=l}^rR_{j,k}-\sum_{j=l}^rL_{j,k}+(r-l+1)$ï¼Œå¦åˆ™å¯ä»¥äºŒåˆ†ä¸€ä¸ªåˆ†ç•Œç‚¹ $x$ï¼Œä½¿å¾— $\forall j \in[l,x], v\ge L_{j,k},\forall j\in[x+1,r],v\le L_{j,k}$ï¼Œåˆ†ç•Œç‚¹å·¦å³ä¸¤æ®µåˆ†åˆ«å¯¹åº”ä¸Šè¿°ä¸¤ç§æƒ…å†µã€‚æ‰€ä»¥åªè¦ç»´æŠ¤äº† $L_{j,k},R_{j,k}$ çš„åŒºé—´ $\min,\max$ å’Œ $sum$ å°±å¯ä»¥ç»´æŠ¤ $\sum_{j=1}^{k-1}\max(R_{j,k}-L_{j,k}+1,0)$ äº†ã€‚

åœ¨å®ç°ä¸Šå¹¶ä¸éœ€è¦æ±‚ $x$ï¼Œå‡è®¾å½“å‰è¦å°† $L_{ql\cdots qr,k}$ èµ‹å€¼ä¸º $v$ï¼Œå½“å‰çº¿æ®µæ ‘ç»“ç‚¹åŒºé—´ä¸º $[l,r]$ï¼Œä¸€èˆ¬åŒºé—´èµ‹å€¼æ˜¯åœ¨ $ql\le l\land r \le qr$ æ—¶åœæ­¢é€’å½’ï¼Œè¿™é‡ŒæŠŠæ¡ä»¶æ”¹æˆ $ql\le l\land r \le qr \land (v \le \min L_{l\cdots r,k}\lor v \ge \max L_{l\cdots r,k})$ æ‰å¯ä»¥æ–¹ä¾¿åœ°ç»´æŠ¤ $\sum_{j=1}^{k-1}\max(R_{j,k}-L_{j,k}+1,0)$ï¼Œç”±äºåªæœ‰ä¸€ä¸ªåˆ†ç•Œç‚¹ï¼Œæ‰€ä»¥å¤æ‚åº¦ä¸å˜ã€‚

å¤æ‚åº¦ $O(n\log n)$ï¼Œå®ç°éš¾åº¦è¾ƒå¤§ï¼Œé™„ä¸Šä»£ç ï¼š

<details><summary><span style="font-size: large; font-weight: bold; color: rgb(33,150,243);">²é¿´´úÂë</span></summary>
```cpp
#include <bits/stdc++.h>
#define rep(i, l, r) for(int i = (l); i <= (r); i++)
#define per(i, r, l) for(int i = (r); i >= (l); i--)
#define mem(a, b) memset(a, b, sizeof a)
#define For(i, l, r) for(int i = (l), i##e = (r); i < i##e; i++)
#define pb push_back
#define eb emplace_back
#define mid ((l + r) / 2)
#define lc o * 2
#define rc o * 2 + 1
#define lch l, mid, lc
#define rch mid + 1, r, rc

using namespace std;
using ll = long long;

const int N = 2e5 + 5;

int n, a[N], pre[N], nxt[N], L[N];
vector<tuple<int, int, int>> vl[N], vr[N];
int tagL[N * 4], minL[N * 4], maxL[N * 4];
int tagR[N * 4], minR[N * 4], maxR[N * 4];
ll sum[N * 4], sumL[N * 4], sumR[N * 4], as;

void pushUp(int o) {
    sum[o] = sum[lc] + sum[rc];
    sumL[o] = sumL[lc] + sumL[rc];
    sumR[o] = sumR[lc] + sumR[rc];
    minL[o] = min(minL[lc], minL[rc]);
    minR[o] = min(minR[lc], minR[rc]);
    maxL[o] = max(maxL[lc], maxL[rc]);
    maxR[o] = max(maxR[lc], maxR[rc]);
}
void pushL(int v, int l, int r, int o) {
    tagL[o] = minL[o] = maxL[o] = v, sumL[o] = v * (r - l + 1ll);
    sum[o] = max(sumR[o] - sumL[o], 0ll);
}
void pushR(int v, int l, int r, int o) {
    tagR[o] = minR[o] = maxR[o] = v, sumR[o] = v * (r - l + 1ll);
    sum[o] = max(sumR[o] - sumL[o], 0ll);
}
void pushDown(int l, int r, int o) {
    if(~tagL[o]) pushL(tagL[o], lch), pushL(tagL[o], rch), tagL[o] = -1;
    if(~tagR[o]) pushR(tagR[o], lch), pushR(tagR[o], rch), tagR[o] = -1;
}
void updL(int L, int R, int v, int l, int r, int o) {
    if(L <= l && r <= R && (v <= minR[o] || v >= maxR[o])) return pushL(v, l, r, o);
    pushDown(l, r, o);
    if(L <= mid) updL(L, R, v, lch);
    if(R > mid) updL(L, R, v, rch);
    pushUp(o);
}
void updR(int L, int R, int v, int l, int r, int o) {
    if(L <= l && r <= R && (v >= maxL[o] || v <= minL[o])) return pushR(v, l, r, o);
    pushDown(l, r, o);
    if(L <= mid) updR(L, R, v, lch);
    if(R > mid) updR(L, R, v, rch);
    pushUp(o);
}
int main() {
    cin >> n;
    rep(i, 1, n) scanf("%d", &a[i]);
    rep(i, 1, n) L[i] = 0;
    rep(i, 1, n) pre[i] = L[a[i]], L[a[i]] = i;
    rep(i, 1, n) L[i] = n + 1;
    per(i, n, 1) nxt[i] = L[a[i]], L[a[i]] = i;
    rep(i, 2, n) {
        int& j = L[i] = i - 1;
        for(; j && pre[j] >= pre[i]; j = L[j]);
        vr[i].eb(max(j, 1), i - 1, pre[i]);
    }
    rep(i, 2, n) {
        int& j = L[i] = i - 1;
        for(; j && nxt[j] <= nxt[i]; j = L[j])
            vl[nxt[j]].eb(max(j, 1), i - 1, L[j]);
    }
    mem(tagL, 63), mem(tagR, -1);
    rep(i, 1, n) {
        for(auto [l, r, v] : vl[i]) updL(l, r, v, 1, n, 1);
        for(auto [l, r, v] : vr[i]) updR(l, r, v, 1, n, 1);
        as += sum[1];
    }
    cout << as;
}
```
</details>

### BaekjoonOJ18733

> ç»™å®š $n$ ä¸ªæ•° $a_i$ï¼Œè¦æŠŠå®ƒä»¬æ”¾è¿› $k$ ä¸ªæœ‰æ ‡å·çš„ç›’å­ä¸­ï¼Œè¦æ±‚æ¯ä¸ªç›’å­éç©ºã€‚
>
> æ¯ä¸ªç›’å­çš„ä»·å€¼ä¸ºç›’å†…æ‰€æœ‰æ•°çš„æŒ‰ä½ä¸ï¼Œè¦æœ€å¤§åŒ–æ‰€æœ‰æ•°çš„ä»·å€¼ï¼ŒåŒæ—¶æ±‚è¾¾åˆ°æœ€å¤§å€¼çš„æ–¹æ¡ˆæ•°ã€‚
>
> $k \le n \le 10^5,0\le a_i \le 10^9$

å¦‚æœæ‰€æœ‰ $a_i=0$ï¼Œé‚£ä¹ˆæ–¹æ¡ˆæ•°ä¸º $k!{n\brace k}$ã€‚

å‡è®¾æ‰€æœ‰ $a_i$ åœ¨äºŒè¿›åˆ¶ä¸‹æœ€é«˜ä½ä¸º $b$ï¼Œå¯ä»¥è¯æ˜æœ€ä¼˜çš„ç­–ç•¥ä¸€å®šä¼šæœ€å¤§åŒ–ä»·å€¼åœ¨ç¬¬ $b$ ä½ä¸º $1$ çš„ç›’å­æ•°é‡ï¼Œåˆ†ä»¥ä¸‹å‡ ç§æƒ…å†µè€ƒè™‘ï¼š

- æ‰€æœ‰ $a_i$ åœ¨ç¬¬ $b$ ä½ä¸º $1$ï¼Œé‚£ä¹ˆæ‰€æœ‰æ–¹æ¡ˆéƒ½ä¼šæœ‰ $k\cdot 2^k$ çš„è´¡çŒ®ï¼ŒæŠŠæ‰€æœ‰ $a_i$ å‡å» $2^b$ ç»§ç»­åšã€‚
- æœ‰ $x$ ä¸ª $a_i$ åœ¨ç¬¬ $b$ ä½ä¸º $1$ã€‚å¦‚æœ $x<k$ï¼Œé‚£ä¹ˆè¿™ $x$ ä¸ª $a_i$ ä¼šä¸€å¯¹ä¸€åœ°æ”¾è¿› $x$ ä¸ªç›’å­ä¸­ï¼Œå…¶ä»–çš„ $a_i$ æ”¾è¿›å‰©ä½™çš„ $k-x$ ä¸ªç›’å­ä¸­ï¼Œæ‰€æœ‰æ–¹æ¡ˆéƒ½ä¼šæœ‰ $x\cdot 2^k$ çš„è´¡çŒ®ï¼Œæ–¹æ¡ˆæ•°ä¹˜ä¸Š $\binom kx$ã€‚
- å¦‚æœ $x\ge k$ï¼Œé‚£ä¹ˆå…¶ä»–çš„ $a_i$ ä¸€å®šæ”¾åœ¨åŒä¸€ä¸ªç›’å­ä¸­ï¼Œæ‰€æœ‰æ–¹æ¡ˆéƒ½ä¼šæœ‰ $(k-1)\cdot 2^k$ çš„è´¡çŒ®ï¼ŒæŠŠç¬¬ $b$ ä½ä¸º $1$ çš„ $a_i$ å‡å» $2^b$ï¼ŒæŠŠæ‰€æœ‰ç¬¬ $b$ ä½ä¸º $0$ çš„ $a_i$ æ›¿æ¢æˆå®ƒä»¬çš„æŒ‰ä½ä¸ã€‚

è¿™æ ·é€’å½’åšä¸‹å»ï¼Œå³å¯ $O(n\log V)$ åœ°æ±‚å‡ºç­”æ¡ˆã€‚

### OpenCup

> [é¢˜ç›®é“¾æ¥](https://official.contest.yandex.ru/opencupXIX/contest/11931/problems/D/?lang=en) [æäº¤è®°å½•](https://official.contest.yandex.ru/opencupXIX/contest/11931/run-report/52963174/)
>
> ç»´æŠ¤ä¸€ä¸ªé•¿åº¦ä¸º $2^p$ çš„æ•°ç»„ $A$ï¼ˆä¸‹æ ‡ä» $0$ å¼€å§‹ï¼‰ï¼Œæ”¯æŒäº”ç§æ“ä½œï¼š
>
> - $A_v$ å¢åŠ  $\delta$ã€‚
>
> - æŸ¥è¯¢ $\sum_{i=l}^rA_i$ã€‚
>
> - ç»™å®š $k$ï¼Œ$\forall i \in [0,2^p)$ï¼Œæ»¡è¶³ $i\text{ and } k\ne i$ï¼Œå°† $A_{i\text{ and }k}$ åŠ ä¸Š $A_i$ï¼Œç„¶åä»¤ $A_i=0$ã€‚
>
> - ç»™å®š $k$ï¼Œ$\forall i \in [0,2^p)$ï¼Œæ»¡è¶³ $i\text{ or } k\ne i$ï¼Œå°† $A_{i\text{ or }k}$ åŠ ä¸Š $A_i$ï¼Œç„¶åä»¤ $A_i=0$ã€‚
>
> - ç»™å®š $k$ï¼Œ$\forall i \in [0,2^p)$ï¼Œæ»¡è¶³ $i\text{ xor } k\ne i$ï¼Œå°† $A_{i\text{ xor }k}$ åŠ ä¸Š $A_i$ï¼Œç„¶åä»¤ $A_i=0$ã€‚
>
> $p\le 19,v,k< 2^p,A_i,\delta \le 10^9$

å…ˆåˆ†æåå¤è¿›è¡Œåä¸‰ç§æ“ä½œåå¯¹ $A$ çš„å½±å“æ˜¯æ€æ ·çš„ï¼Œå¯¹äºä¸€ä¸ª $A_i$ï¼Œå‡å¦‚å®ƒæœ€ç»ˆåŠ åˆ°äº† $A_j$ ä¸Šï¼ˆ$A_i$ ä¸å˜è®¤ä¸º $i=j$ï¼‰ï¼Œé‚£ä¹ˆ $j$ æ˜¯æŠŠ $i$ çš„æŸäº›ä½èµ‹ä¸º $0$ï¼ŒæŸäº›ä½èµ‹ä¸º $1$ï¼ŒæŸäº›ä½ $01$ ç¿»è½¬å¾—åˆ°çš„ï¼Œä¸éš¾ç”¨ $tag_0,tag_1,tag_f$ ä¸‰ä¸ªçŠ¶å‹æ ‡è®°æ¥è¡¨ç¤ºåä¸‰ç§æ“ä½œçš„å½±å“ã€‚

è€ƒè™‘ç”¨ `0-1 trie` ç»´æŠ¤è¿™ä¸ªåºåˆ—ï¼Œæ¯ä¸ªç»“ç‚¹ç»´æŠ¤ $tag_0(u),tag_1(u),tag_f(u)$ ä¸‰ä¸ªæ‡’æ ‡è®°ï¼Œé—®é¢˜æ˜¯æ€ä¹ˆä¸‹æ”¾æ ‡è®°ï¼Œå‡è®¾å½“å‰è¦å°†ç»“ç‚¹ $u$ ä¸Šçš„æ ‡è®°ä¸‹æ”¾ã€‚

é¦–å…ˆéœ€è¦å°†æ ‡è®°ä¼ ç»™å·¦å³å„¿å­ï¼Œå¯¹äºå„¿å­ $v$ï¼Œå®ƒæŒ‰å¦‚ä¸‹æ–¹å¼æ¥å— $tag_0(u),tag_1(u),tag_f(u)$ å¯¹å®ƒçš„å½±å“ï¼š

- $tag_0(v)=tag_0(v)\cup tag_0(u),tag_1(v)=tag_1(v)\setminus tag_0(u),tag_f(v)=tag_f(v)\setminus tag_0(u)$ã€‚

- $tag_1(u)$ ç±»ä¼¼ã€‚

- è®¾ $x=tag_0(v)\cap tag_f(u),y=tag_1(v)\cap tag_f(u)$ï¼Œé‚£ä¹ˆ $tag_0(v)=(tag_0(v)\setminus x)\cap y,tag_1(v)=(tag_1(v)\setminus y)\cap x,tag_f(v)=(tag_f(v)\cap tag_f(u))\setminus x\setminus y$ã€‚

ç”¨ä½è¿ç®—å¯ä»¥åšåˆ° $O(1)$ã€‚

å¦å¤–è¿˜è¦è€ƒè™‘æ ‡è®°å¯¹ç‚¹ $u$ è‡ªå·±çš„å½±å“ï¼Œè®¾ç‚¹ $u$ å¯¹åº”ç¬¬ $d$ ä½ï¼Œåˆ†ä¸‰ç§æƒ…å†µï¼š

- å¦‚æœ $tag_0(u)$ åŒ…å«ç¬¬ $d$ ä½ï¼Œéœ€è¦å°† $u$ çš„å³å­æ ‘åˆå¹¶åˆ°å·¦å­æ ‘å»ã€‚
- å¦‚æœ $tag_1(u)$ åŒ…å«ç¬¬ $d$ ä½ï¼Œéœ€è¦å°† $u$ çš„å·¦å­æ ‘åˆå¹¶åˆ°å³å­æ ‘å»ã€‚
- å¦‚æœ $tag_f(u)$ åŒ…å«ç¬¬ $d$ ä½ï¼Œéœ€è¦å°† $u$ çš„å·¦å³å­æ ‘äº¤æ¢ã€‚

äº¤æ¢å·¦å³å­æ ‘æ˜¯å®¹æ˜“çš„ï¼Œå°†ä»¥ $v$ ä¸ºæ ¹çš„å­æ ‘åˆå¹¶åˆ°ä»¥ $u$ ä¸ºæ ¹çš„å­æ ‘å¯ä»¥åƒçº¿æ®µæ ‘åˆå¹¶ä¸€æ ·åšï¼š

- å¦‚æœ $u,v$ ä¸­æœ‰ä¸€ä¸ªæ˜¯ç©ºçš„ï¼Œå°±è¿”å›ã€‚

- å¦åˆ™ä¸‹æ”¾ $u,v$ çš„æ ‡è®°ï¼Œç„¶ååˆ†åˆ«åˆå¹¶ $u,v$ çš„å·¦å³å„¿å­ï¼Œå¹¶åˆ é™¤ $v$ã€‚

ç”±äºç¬¬äºŒç§æƒ…å†µæ¯å‘ç”Ÿä¸€æ¬¡å°±ä¼šåˆ ä¸€ä¸ªç»“ç‚¹ï¼Œæ‰€ä»¥å¤æ‚åº¦å‡æ‘Šæ˜¯ $O(p)$ çš„ã€‚

å¯¹äºå•ç‚¹åŠ å’ŒåŒºé—´æŸ¥è¯¢ï¼Œåƒæ™®é€šçº¿æ®µæ ‘ä¸€æ ·åšå°±è¡Œäº†ï¼Œæ³¨æ„ç”±äºå­æ ‘åˆå¹¶ä¼šåˆ é™¤ç»“ç‚¹ï¼Œæ‰€ä»¥å•ç‚¹åŠ çš„æ—¶å€™å¦‚æœé‡åˆ°äº†ä¸å­˜åœ¨çš„ç»“ç‚¹æ—¶éœ€è¦åŠ¨æ€å¼€ç‚¹ã€‚

å¤æ‚åº¦ $O(p2^p)$ã€‚

### BaekjoonOJ19394

> ç»™å®šä¸€å¼  $n$ ä¸ªç‚¹ $m$ æ¡è¾¹çš„æ— å‘å›¾ï¼Œå®šä¹‰ä¸€ä¸ªè¾¹çš„å­é›†æ˜¯å¥½çš„å½“ä¸”ä»…å½“ä»…ä¿ç•™è¿™äº›è¾¹æ—¶ï¼Œæ¯ä¸ªç‚¹çš„åº¦æ•°ä¸ºå¶æ•°ã€‚
>
> é—®æ‰€æœ‰å¥½çš„è¾¹é›†çš„è¾¹æ•°å¹³æ–¹å’Œã€‚
>
> $n,m\le 2\cdot 10^5$

ä¸‹é¢ç§°åˆæ³•è¾¹é›†ä¸ºæ¬§æ‹‰å­å›¾ã€‚

é¦–å…ˆæ¬§æ‹‰å­å›¾çš„æ•°é‡æ˜¯å¤šå°‘ï¼Ÿç­”æ¡ˆæ˜¯ $2^{m-n+c}$ï¼Œå…¶ä¸­ $c$ æ˜¯è¿é€šå—æ•°ã€‚è€ƒè™‘æ±‚å‡ºå›¾çš„ä¸€ä¸ªç”Ÿæˆæ£®æ—ï¼Œé‚£ä¹ˆæœ‰ $m-n+c$ æ¡éæ ‘è¾¹ï¼Œæ¯æ¡éæ ‘è¾¹å’Œå®ƒä¸¤ä¸ªç«¯ç‚¹çš„æ ‘ä¸Šè·¯å¾„æ„æˆä¸€ä¸ªåŸºç¯ï¼Œä»è¿™äº›åŸºç¯ä¸­é€‰è‹¥å¹²ä¸ªå¼‚æˆ–èµ·æ¥å°±èƒ½å¾—åˆ°ä¸€å¼ æ¬§æ‹‰å­å›¾ï¼ŒåŒæ—¶ä»»æ„ä¸€å¼ æ¬§æ‹‰å­å›¾ä¸€å®šæ˜¯è‹¥å¹²åŸºç¯å¼‚æˆ–èµ·æ¥çš„ã€‚

å‡è®¾ä¸€å¼ æ¬§æ‹‰å­å›¾æœ‰ $x$ æ¡è¾¹ï¼Œå®ƒçš„è´¡çŒ® $x^2=2\binom x2+x$ï¼Œ$x$ å¯ä»¥è€ƒè™‘æ¯æ¡è¾¹çš„è´¡çŒ®ï¼Œ$\binom x2$ å¯ä»¥è€ƒè™‘æ¯å¯¹è¾¹çš„è´¡çŒ®ã€‚

- ä¸€æ¡è¾¹ $e$ çš„è´¡çŒ®ã€‚å¦‚æœ $e$ æ˜¯å‰²è¾¹ï¼Œé‚£ä¹ˆå®ƒæ²¡æœ‰è´¡çŒ®ï¼Œå¦åˆ™è´¡çŒ®ç­‰äºåˆ æ‰å®ƒåçš„æ¬§æ‹‰å­å›¾æ•°é‡ $2^{m-1-n+c}$ã€‚
- ä¸€å¯¹è¾¹ $e_1,e_2$ çš„è´¡çŒ®ã€‚å¦‚æœ $e_1,e_2$ ä¸­æœ‰å‰²è¾¹ï¼Œé‚£ä¹ˆæ²¡æœ‰è´¡çŒ®ï¼Œå¦åˆ™è´¡çŒ®ç­‰äºåˆ æ‰å®ƒä»¬åçš„æ¬§æ‹‰å­å›¾æ•°é‡ï¼Œå¦‚æœ $e_1,e_2$ æ˜¯å‰²é›†ï¼Œè´¡çŒ®ä¸º $2^{m-1-n+c}$ï¼Œå¦åˆ™ä¸º $2^{m-2-n+c}$ã€‚

å› æ­¤é—®é¢˜æ˜¯æ•°æœ‰å¤šå°‘å¯¹éå‰²è¾¹æ˜¯å‰²é›†ï¼Œç”¨æ•°æ®ç»“æ„å½“ç„¶æ˜¯å¯ä»¥åšçš„ï¼Œä½†æœ‰ä¸€ä¸ªä¼˜ç§€åšæ³•ã€‚

åˆ¤æ–­ $k$ æ¡è¾¹æ˜¯å¦ç»„æˆå‰²é›†æœ‰å¦‚ä¸‹ç®—æ³•ï¼š

- æ±‚å‡ºç”Ÿæˆæ ‘ï¼Œç»™æ¯éæ ‘è¾¹éšæœºä¸€ä¸ª $[0,2^{64})$ å†…çš„æƒå€¼ã€‚
- æ¯æ¡æ ‘è¾¹çš„æƒå€¼ç­‰äºæ‰€æœ‰è¦†ç›–å®ƒçš„éæ ‘è¾¹çš„æƒå€¼çš„å¼‚æˆ–å’Œï¼Œå‰²è¾¹æƒå€¼ä¸º $0$ã€‚
- $k$ æ¡è¾¹ç»„æˆå‰²é›†å½“å‰ä»…å½“å…¶ä¸­ä¸€äº›è¾¹çš„å¼‚æˆ–å’Œä¸º $0$ã€‚

è¿™ä¸ªæ¡ä»¶æ˜¯å‰²é›†çš„å……åˆ†æ¡ä»¶ï¼Œæœ‰ $2^{k-64}$ çš„æ¦‚ç‡è¯¯åˆ¤æˆå‰²é›†ï¼Œä½†ç”¨æ¥æ•°ä¸¤æ¡è¾¹çš„å‰²é›†æ˜¯å¾ˆéš¾å‡ºé”™çš„ï¼Œå¯ä»¥è®¤ä¸ºä¸¤æ¡éå‰²è¾¹ç»„æˆå‰²é›†å½“ä¸”ä»…å½“ä¸¤æ¡è¾¹æƒå€¼ç›¸ç­‰ã€‚

ç›´æ¥ç»Ÿè®¡æœ‰å¤šå°‘å¯¹è¾¹æƒå€¼ç›¸ç­‰å°±è¡Œäº†ï¼Œå¤æ‚åº¦ $O(n\log n)$ æˆ– $O(n)$ï¼ˆå“ˆå¸Œè¡¨ï¼‰ã€‚

### OpenCup

> [é¢˜ç›®é“¾æ¥](https://official.contest.yandex.ru/opencupXVIII/contest/5917/problems/E/?success=53051713&lang=en) [æäº¤è®°å½•](https://official.contest.yandex.ru/opencupXVIII/contest/5917/run-report/53051713/)
>
> ç»™å®šå­—ç¬¦ä¸² $s,t$ï¼Œæ¯æ¬¡å¯ä»¥åˆ é™¤ $s$ ä¸­ä¸€ä¸ªå­—ç¬¦ $c$ çš„ç¬¬ä¸€æ¬¡å‡ºç°æˆ–æœ€åä¸€æ¬¡å‡ºç°ï¼Œåˆ é™¤ä»£ä»·å–å†³äºåˆ é™¤å­—ç¬¦çš„åˆå§‹ä½ç½®ã€‚
>
> $|s|,|t| \le 2\cdot 10^5$

å…ˆè€ƒè™‘ä¸€ä¸ª $O(n^2)$ çš„ `DP`ï¼Œè®¾ $f_{i,j}$ è¡¨ç¤ºä½¿ $s_{1\cdot i}$ å’Œ $t_{1\cdots j}$ ç›¸ç­‰çš„æœ€å°ä»£ä»·ï¼Œè½¬ç§»ä¸ºï¼š

- $f_{i,j}\leftarrow f_{i-1,j-1}(s_i=t_j)$ã€‚
- $f_{i,j}\leftarrow f_{i-1,j}(t_{1\cdots j} æˆ– t_{j+1\cdots |t|} ä¸­æ²¡æœ‰å­—ç¬¦s_i)$ã€‚

è®¾ $first(c)$ è¡¨ç¤ºå­—ç¬¦ $c$ åœ¨ $t$ ä¸­ç¬¬ä¸€æ¬¡å‡ºç°çš„ä½ç½®ï¼Œ$last(c)$ è¡¨ç¤ºæœ€åä¸€æ¬¡å‡ºç°çš„ä½ç½®ï¼Œé‚£ä¹ˆè½¬ç§»äºŒçš„æ¡ä»¶å¯ä»¥æ”¹å†™ä¸º $j<first(s_i)\lor j\ge last(s_i)$ã€‚

å½“ $j\ne first(s_i)\land j\ne last(s_i)$ æ—¶ä¸¤ç§è½¬ç§»åªèƒ½é€‰æ‹©ä¸€ç§ï¼Œè€ƒè™‘ä»è¿™é‡Œä¼˜åŒ–ã€‚

æŠŠæ‰€æœ‰çš„ $first(c),last(c)$ æ ‡è®°ä¸ºå…³é”®å€¼ï¼Œé‚£ä¹ˆæœ€å¤šæœ‰ $52$ ä¸ªå…³é”®å€¼ï¼Œè€ƒè™‘åªè®¡ç®— $j$ ä¸ºå…³é”®å€¼çš„ $f_{i,j}$ï¼Œè®¾ $j$ ä¹‹åçš„ä¸€ä¸ªå…³é”®å€¼ä¸º $j'$ï¼Œå…ˆä» $f_{*,j}$ è½¬ç§»åˆ° $f_{*,j'-1}$ï¼Œåœ¨è¿™ä¸€è¿‡ç¨‹ï¼Œ$s$ ä¸­ä¸€äº›å­—ç¬¦å¿…é¡»è¿›è¡Œè½¬ç§»ä¸€ï¼Œå…¶ä»–å­—ç¬¦å¿…é¡»è¿›è¡Œè½¬ç§»äºŒï¼Œå› æ­¤ä¸€ä¸ª $f_{i,j}$ æœ€å¤šèƒ½è½¬ç§»åˆ°ä¸€ä¸ªçš„ $f_{i',j'-1}$ï¼Œå…·ä½“è½¬ç§»åˆ°å“ªä¸€ä¸ª $i'$ å¯ä»¥é€šè¿‡ KMP ç®—å‡ºï¼Œç„¶åå†ä» $f_{*,j'-1}$ è½¬ç§»åˆ° $f_{*,j'}$

å¤æ‚åº¦ $O(26n)$ã€‚

### OpenCup

> [é¢˜ç›®é“¾æ¥](https://official.contest.yandex.ru/opencupXX/contest/17756/problems/J/) [æäº¤è®°å½•](https://official.contest.yandex.ru/opencupXX/contest/17756/run-report/53639932/)
>
> ç»™å®šä¸¤ä¸ªé•¿åº¦ä¸º $n$ çš„ 01 ä¸² $s,t$ï¼Œå¯ä»¥å¯¹ $s$ è¿›è¡Œä»¥ä¸‹ä¸‰ç§æ“ä½œä»»æ„æ¬¡ï¼š
>
> - ä»¤ $s_i=0$ï¼Œä»£ä»·ä¸º $t_0$ã€‚
> - ä»¤ $s_i=1$ï¼Œä»£ä»·ä¸º $t_1$ã€‚
> - äº¤æ¢ $s_i,s_{i+1}$ï¼Œä»£ä»·ä¸º $t_s$ã€‚
>
> $n \le 4\cdot 10^6$

å¯ä»¥æŠŠæ‰€æœ‰äº¤æ¢æ“ä½œè°ƒæ•´åˆ°æœ€å‰é¢ï¼Œå³å…ˆç”¨äº¤æ¢æ“ä½œæŠŠ $s$ å˜æˆ $s'$ï¼Œå†ç”¨ä¿®æ”¹æ“ä½œæŠŠ $s'$ å˜æˆ $t$ã€‚

è€ƒè™‘ $s$ å˜æˆ $s'$ çš„æœ€å°ä»£ä»·ï¼Œå‡è®¾ $s_i$ äº¤æ¢åçš„ä½ç½®ä¸º $s'_{p_i}$ï¼Œå¯ä»¥è¯æ˜æœ€ä¼˜çš„ $p$ æ»¡è¶³ï¼š$p_{p_i}=i$ã€‚å¯ä»¥è®¤ä¸ºäº¤æ¢ä½ç½® $i,j$ çš„ä»£ä»·æ˜¯ $t_s|i-j|$ï¼Œä»»ä½•ä½ç½®æœ€å¤šå‚ä¸ä¸€æ¬¡äº¤æ¢ã€‚

å¯¹äºæ»¡è¶³ $s_i=t_i$ çš„ $i$ï¼Œå®ƒä»¬æ²¡æœ‰å¿…è¦å‚ä¸äº¤æ¢ï¼Œåˆ é™¤è¿™äº›ä½ç½®åæ»¡è¶³ä¸¤ä¸ªæ€§è´¨ï¼š

- ä»»ä½•äº¤æ¢ $(i_1,j_1),(i_2,j_2)$ éƒ½æ˜¯ä¸ç›¸äº¤çš„ï¼Œå³åŒºé—´ $[i_1,j_1]$ å’ŒåŒºé—´ $[i_2,j_2]$ ä¸ç›¸äº¤ã€‚
- å¯¹äºä»»ä½•äº¤æ¢ $(i,j)$ï¼ŒåŒºé—´ $(i,j)$ ä¸­æ‰€æœ‰ä½ç½®éƒ½å‚ä¸äº¤æ¢ã€‚

ç»¼ä¸Šï¼Œå¯¹äºæ‰€æœ‰çš„æå¤§äº¤æ¢ $(i,j)$ï¼Œä¸å¦¨å‡è®¾ $s_i=0,s_j=1$ï¼ŒæŠŠ $0$ å˜æˆ '('ï¼Œ$1$ å˜æˆ ')'ï¼ŒåŒºé—´ $[i,j]$ æ˜¯ä¸€ä¸ªåˆæ³•æ‹¬å·ä¸²ï¼Œå¹¶ä¸” $i$ å’Œ $j$ æ˜¯åŒ¹é…çš„ã€‚è¿™æ„å‘³ç€å¦‚æœ $s_i$ è¦å’Œ $s_j(j<i)$ äº¤æ¢ï¼Œé‚£ä¹ˆ $j$ æ˜¯å”¯ä¸€çš„ï¼ˆæˆ–è€…æ²¡æœ‰ï¼Œå½“æ‰€æœ‰çš„ $[j,i]$ éƒ½ä¸æ˜¯åˆæ³•æ‹¬å·ä¸²æ—¶ï¼‰ã€‚

ç„¶åå°±å¯ä»¥ `DP` äº†ï¼Œè®¾ $f_i$ è¡¨ç¤ºæŠŠ $s[1\cdots i] \rightarrow t[1\cdots i]$ çš„æœ€å°ä»£ä»·ï¼Œè½¬ç§»ä¸ºï¼š

$$
f_i=\min(f_{i-1}+t_{1-s_i},f_{j-1}+\text{cost}(j,i))
$$

å…¶ä¸­ $j$ æ˜¯å’Œ $i$ åŒ¹é…çš„ä½ç½®ï¼Œ$\text{cost}(j,i)$ æ˜¯åŒºé—´ $[j,i]$ ä¸­æ‰€æœ‰åŒ¹é…çš„ä½ç½® $x,y$ çš„ $t_s|x-y|$ ä¹‹å’Œï¼Œå¯ä»¥ç”¨æ ˆç»´æŠ¤ã€‚

å¦ä¸€ä¸ªæ­£ç¡®çš„è½¬ç§»ä¸ºï¼š

$$
f_i=\min(f_{i-1}+t_{1-s_i},f_{j-1}+f_{i-1}-f_j)
$$

æ­£ç¡®çš„åŸå› æ˜¯ $f_{j-1}+f_{i-1}-f_j \le f_{j-1}+\text{cost}(j,i)$ï¼Œå¹¶ä¸” $f_{j-1}+f_{i-1}-f_j \le f_{j-1}$ æ˜¯ä¸€ä¸ªåˆæ³•æ–¹æ¡ˆçš„ä»£ä»·ï¼ˆé‚£ä¸ªæ–¹æ¡ˆçš„æè¿°æœ‰ç‚¹å¤æ‚ï¼Œç•¥ï¼‰ã€‚

å¤æ‚åº¦ $O(n)$ã€‚
