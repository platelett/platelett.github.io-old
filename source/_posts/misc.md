---
title: æ‚é¡¹
date: 2021-08-23 23:35:20
updated: 2021-08-23 23:35:20
tags: []
categories: ç®—æ³•
---
### Barrett reduction å–æ¨¡ä¼˜åŒ–

> è®¡ç®— $ab\bmod m(0\le a,b<m<2^{31})$ã€‚

å¦‚æœ $m$ åœ¨ç¼–è¯‘æ—¶å·²çŸ¥ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨å°±ä¼šå¸®ä½ å®Œæˆè¿™ä¸ªä¼˜åŒ–ï¼ˆå‡†ç¡®åœ°è¯´æ˜¯ä¸‹é¢çš„å˜ç§ï¼‰ï¼Œå¦åˆ™ä½ å¯ä»¥è‡ªå·±å®ç°ã€‚

#### åŸç”Ÿç®—æ³•

é¦–å…ˆï¼Œè®¾ $m^{-1}$ è¡¨ç¤ºæµ®ç‚¹æ•°å½¢å¼çš„ $\frac 1m$ã€‚
$$
ab\bmod m=ab-\lfloor ab\cdot m^{-1}\rfloor m
$$
å³ä½¿é¢„å¤„ç†äº† $m^{-1}$ï¼Œç”±äºæµ®ç‚¹æ•°ä¹˜æ³•æ¯”æ•´æ•°é™¤æ³•å¿«ä¸äº†å¤šå°‘ï¼Œè€ƒè™‘è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œå– $\frac {m'}{2^k}\approx m^{-1}$ï¼Œç„¶å
$$
\lfloor ab\cdot m^{-1}\rfloor \approx \lfloor \frac{abm'}{2^k}\rfloor
$$
è®¡ç®—å³è¾¹å°±å¿«å¤šäº†ï¼Œå› ä¸ºåªæœ‰æ•´æ•°ä¹˜æ³•å’Œå³ç§»ï¼Œå¦‚ä½•åˆç†é€‰å– $m'$ å’Œ $k$ï¼Ÿ

ä»¤ $k=2\lceil \log_2 m\rceil,m'=\lceil \frac{2^k}m\rceil$ï¼Œä¸‹é¢åˆ†æè¯¯å·®ï¼š

- è®¾ $m'm=2^k+r(0\le r<m)$
- è®¾ $ab=cm+d(0\le c,d<m)$
- $abm'=(cm+d)m'=cm'm+dm'=c2^k+cr+dm'$
- $cr+dm'<(m-1)^2+m'm<(m-1)^2+2^k+(m-1)=2^k+m(m-1)<2^k\cdot 2$
- $\lfloor \frac{abm'}{2^k}\rfloor=c\ \text{or}\ c+1$

è®¾çœŸå®ç­”æ¡ˆä¸º $ans$ï¼Œé‚£ä¹ˆ $ab-\lfloor \frac{abm'}{2^k}\rfloor m=ans\ \text{or}\ ans-m$ã€‚

æ›´ä¸€èˆ¬çš„ç»“è®ºæ˜¯åªè¦ $c \ge \max(a, b^2)$ï¼Œ$\lfloor \frac{a\lfloor \frac cb\rfloor}c\rfloor=\lfloor \frac ab\rfloor\ \text{or}\ \lfloor \frac ab\rfloor+1$ æˆç«‹ã€‚

å®è·µä¸­å¯ä»¥ä»¤ $k=64$ï¼Œå¯ä»¥ç”¨ `~0ull / m + 1` æ¥è®¡ç®— $m'$ã€‚

<details><summary><span style="font-size: large; font-weight: bold; color: rgb(33,150,243);">²é¿´´úÂë</span></summary>
```cpp
using uint = unsigned int;
using ull = unsigned long long;
struct barrett {
    uint m; ull im;
    barrett(uint m) :m(m), im(~0ull / m + 1) {}
    uint mul(uint a, uint b) const {
        ull z = (ull)a * b;
        uint v = z - uint((__uint128_t)z * im >> 64) * m;
        return m <= v ? v + m : v;
    }
};
```
</details>

é€Ÿåº¦æ¯”è¾ƒï¼šå…ˆåœ¨ $[0, m)$ ä¸­éšæœºç”Ÿæˆ $10^5$ ä¸ªæ•°ï¼Œç„¶åè®¡ç®—ä¸¤ä¸¤ä¹˜ç§¯æ¨¡ $m$ çš„å¼‚æˆ–å’Œã€‚

æµ‹è¯•ç³»ç»Ÿ `ubuntu-21.04`ï¼ˆå› ä¸º `Linux` æ¯”è¾ƒç¨³å®šï¼‰ï¼Œæ¯ä¸ªæ ¼å­å‰è€…ä¸ºç›´æ¥å–æ¨¡çš„æ—¶é—´ï¼Œåè€…ä¸º `Barrett reduction` å–æ¨¡çš„æ—¶é—´ã€‚

| ç¼–è¯‘é€‰é¡¹\æ¨¡æ•° |  998244353  | 1000000007  | 1000000009  |  19260817   |
| :-----------: | :---------: | :---------: | :---------: | :---------: |
|      æ—        | 47.1s/29.6s | 45.7s/30.2s | 46.6s/30.4s | 45.8s/29.2s |
|      -O2      | 35.8s/6.4s  | 35.2s/6.1s  | 35.0s/6.3s  | 35.4s/6.3s  |

#### æ— è¯¯å·®é™¤æ³•çš„å˜ç§

~~å¾ˆå¿«å°±ä¼šå†™ã€‚~~

#### é€Ÿåº¦æ›´å¿«çš„ Lemire reduction

~~å¾ˆå¿«å°±ä¼šå†™ã€‚~~

å¦å¤–ï¼Œç¬”è€…æƒ³åˆ°äº†ä¸¤ä¸ªå¯ä»¥åº”ç”¨çš„åœ°æ–¹ã€‚

- é«˜ç²¾åº¦è®¡ç®— $ab\bmod m$ï¼Œé«˜ç²¾åº¦ä¹˜æ³•æ˜¯å¯ä»¥ç”¨ `FFT` ä¼˜åŒ–åˆ° $O(\log m\log\log m)$ çš„ï¼ˆä¸¥æ ¼æ¥è®²ï¼Œå¦‚æœ $m$ ä½æ•°è¿‡äºå·¨å¤§ï¼Œä»¥è‡´äºç›´æ¥æ±‚å·ç§¯ä¼šæº¢å‡ºæ—¶ï¼Œéœ€è¦ç”¨åˆ° `SchÃ¶nhage-Strassen` ç®—æ³•ï¼Œå¤æ‚åº¦ $O(\log m\log\log m\log \log \log m)$ï¼Œè¿™é‡Œç²—ç•¥åœ°åˆ†æä¸º $O(\log m\log\log m)$ï¼Œåé¢çš„å¤æ‚åº¦åˆ†æä¹Ÿæ˜¯å¦‚æ­¤ï¼‰ï¼Œè€Œå–æ¨¡åªèƒ½ $O(\log^2 m)$ã€‚å½“ $m$ å›ºå®šæ—¶ï¼Œå¯ä»¥äº‹å…ˆ $O(\log^2 m)$ è®¡ç®—å‡º $m'$ï¼Œç„¶åå°±å¯ä»¥ $O(\log m\log\log m)$ åœ°å–æ¨¡äº†ã€‚å°†æ­¤åº”ç”¨äº `Miller Rabin` ç´ æ€§æ£€éªŒå¯ä»¥å°†å¤æ‚åº¦ä¼˜åŒ–åˆ° $O(k\log^2n\log\log n)$ã€‚

- åŠ é€Ÿè®¡ç®— $\gcd(a,b)$ã€‚å¦‚æœ $a,b$ éƒ½æ¯”è¾ƒå°ï¼Œè€Œæ¬¡æ•°å¾ˆå¤šï¼Œæ¯”å¦‚ $a,b\le 10^7$ï¼Œè¦æ±‚ $5\cdot 10^7$ æ¬¡ $\gcd$ã€‚

  å¯¹äº $m$ï¼Œä»¤ $k=\max(24,2\lceil \log_2m\rceil)$ï¼Œå½“ $m=b$ æ—¶ï¼Œ$am'$ åœ¨ `long long` èŒƒå›´å†…ï¼Œå¯ä»¥å¾ˆæœ‰æ•ˆåœ°ä¼˜åŒ–ã€‚

### å¡ç‰¹å…°æ•°çš„ä¸¤ä¸ªæ‰©å±•

æœ¬èŠ‚æ‰€æœ‰çš„è·¯å¾„éƒ½æ˜¯æŒ‡æ¯ä¸€æ­¥å‘ä¸Šæˆ–å‘å³èµ°ä¸€ä¸ªå•ä½é•¿åº¦çš„è·¯å¾„ã€‚

> ç»™å®šä¸€æ¡ç›´çº¿ $l:y=kx+b$ï¼Œæ±‚ä» $(0,0)$ èµ°åˆ° $(a, l(a))$ ä¸”ä¸è¶Šè¿‡ $l$ çš„è·¯å¾„æ¡æ•°ã€‚
>
> $k,b,a$ éƒ½æ˜¯æ­£æ•´æ•°ã€‚

è®° $G(k,b,a)$ è¡¨ç¤ºè¿™ä¸ªè·¯å¾„æ¡æ•°ã€‚

è€ƒè™‘ä» $(0,0)$ èµ°åˆ° $(a, l(a))$ çš„è·¯å¾„æ¡æ•°ï¼Œå®ƒå¯èƒ½ä¸ä¼šè¶Šè¿‡ $l$ï¼Œè¿™éƒ¨åˆ†è·¯å¾„æ¡æ•°ä¸º $G(k,b,a)$ï¼Œå¦åˆ™å¯ä»¥æšä¸¾è·¯å¾„ç¬¬ä¸€æ¬¡è¶Šè¿‡ $l$ æ—¶çš„æ¨ªåæ ‡ $i$ï¼Œå¾—åˆ° $(1)$ å¼ï¼š
$$
\binom {l(a)+a}a=G(k,b,a)+\sum_{i+j=a}G(k,b,i)\binom{kj+j-1}j
$$

è€ƒè™‘ä» $(0,0)$ èµ°åˆ° $(a-1,l(a))$ çš„è·¯å¾„æ¡æ•°ï¼Œå®ƒä¸€å®šä¼šè¶Šè¿‡ $l$ï¼Œæšä¸¾è·¯å¾„ç¬¬ä¸€æ¬¡è¶Šè¿‡ $l$ æ—¶çš„æ¨ªåæ ‡ $i$ï¼Œå¾—åˆ° $(2)$ å¼ï¼š
$$
\binom {l(a)+a}{a-1}=\sum_{i+j=a}G(k,b,i)\binom {kj+j-1}{j-1}
$$

æ³¨æ„åˆ°
$$
\frac{\binom{kj+j-1}j}{\binom{kj+j-1}{j-1}}=\frac{kj}j=k
$$
$(1)-(2)\times k$ å¾—ï¼š
$$
G(k,b,a)=\binom{l(a)+a}a-k\binom{l(a)+a}{a-1}
$$

>ç»™å®šä¸€æ¡ç›´çº¿ $l:y=kx+b$ï¼Œæ±‚ä» $(0,0)$ èµ°åˆ° $(x,y)$ çš„æ‰€æœ‰è·¯å¾„ä¸ $l$ çš„äº¤ç‚¹æ€»æ•°ã€‚
>
>$k,b,a$ éƒ½æ˜¯æ­£æ•´æ•°ï¼Œ$l(x) \le y$ã€‚

è®° $F(k,b,x,y)$ è¡¨ç¤ºè¿™ä¸ªäº¤ç‚¹æ€»æ•°ã€‚

è€ƒè™‘æ¯ä¸ªäº¤ç‚¹çš„è´¡çŒ®ï¼Œæšä¸¾äº¤ç‚¹çš„æ¨ªåæ ‡ $i$ï¼Œå¾—åˆ°ï¼š
$$
F(k,b,x,y)=\sum_{i+j=x}\binom{l(i)+i}i\binom{y-l(i)+j}j
$$
è¿›ä¸€æ­¥
$$
\begin{aligned}
&F(k,b,x,y)-kF(k,b,x-1,y+1)\\
&=\sum_{i+j=x}\binom{l(i)+i}i\binom{y-l(i)+j}j-k\binom{l(i)+i}i\binom{y-l(i)+j}{j-1}\\
&=\sum_{i+j=x}\binom{l(i)+i}i\left(\binom{y-l(i)+j}j-k\binom{y-l(i)+j}{j-1}\right)\\
&=\sum_{i+j=x}\binom{l(i)+i}iG(k,y-l(x),j)
\end{aligned}
$$
æ³¨æ„åˆ° $\binom{l(i)+i}i$ æ˜¯ä» $(0,0)$ èµ°åˆ° $(i,l(i))$ çš„è·¯å¾„æ¡æ•°ï¼Œè€Œ $G(k,y-l(x),j)$ æ˜¯ä» $(x,y+1)$ **å€’ç€**èµ°åˆ° $(i,l(i)+1)$ ä¸”ä¸è¶Šè¿‡ $l$ çš„è·¯å¾„æ¡æ•°ï¼Œæ•´ä½“æ±‚å’Œå°±æ˜¯ä» $(0,0)$ èµ°åˆ° $(x,y+1)$ çš„è·¯å¾„æ¡æ•°ï¼Œå› ä¸º $i$  å°±æ˜¯åœ¨æšä¸¾æœ€åä¸€æ¬¡è¶Šè¿‡ $l$ æ—¶çš„æ¨ªåæ ‡ã€‚

äºæ˜¯
$$
F(k,b,x,y)=kF(k,b,x-1,y+1)+\binom{x+y+1}x
$$
å› ä¸º $F(k,b,x+y,0)=1$

å½’çº³å¾—åˆ°
$$
F(k,b,x,y)=\sum_{i+j=x}\binom{x+y+1}ik^j
$$
å®ƒç”šè‡³å’Œ $b$ æ— å…³ã€‚



### Lucasâ€“Lehmer ç´ æ€§æ£€éªŒ

> åŸç†ï¼š$M_p=2^p-1(p\in\text{Odd prime})$ æ˜¯è´¨æ•°å½“ä¸”ä»…å½“ $M_p|(2+\sqrt 3)^{2^{p-2}}+(2-\sqrt 3)^{2^{p-2}}$ã€‚

åé¢æœ‰è¯æ˜ã€‚

ç®—æ³•ï¼šä»¤ $s_n=(2+\sqrt 3)^{2^n}+(2-\sqrt 3)^{2^n}\bmod M_p$ï¼Œé‚£ä¹ˆ
$$
s_n=\begin{cases}
4&(i=0)\\
s_{n-1}^2-2\bmod M_p&(i>1)
\end{cases}
$$
è®¡ç®—å¹³æ–¹å¯ä»¥ç”¨ `FFT` åšåˆ° $O(p\log p)$ï¼Œç”±äºæ¨¡æ•°å¾ˆç‰¹æ®Šï¼Œå–æ¨¡å¯ä»¥åšåˆ°çº¿æ€§ï¼š

$a \bmod M_p=(a_0\cdot 2^p+a_1)\bmod M_p=(a_0+a_1)\bmod M_p$

$s_{n-1}^2-2$ æœ€å¤šå±•å¼€ä¸¤éå°±è¡Œäº†ï¼Œå¤æ‚åº¦ $O(p^2\log p)$ã€‚

#### å……åˆ†æ€§

åè¯æ³•ï¼šå‡è®¾ $M_p$ æ˜¯åˆæ•°ï¼Œå®ƒçš„æœ€å°è´¨å› å­ä¸º $q$ï¼Œå®šä¹‰ä¸€ä¸ª $q^2$ ä¸ªå…ƒç´ çš„é›†åˆ $X=\{a+b\sqrt 3|a,b\in\mathbb Z_q\}$ï¼Œå…¶ä¸­ $\mathbb Z_q$ è¡¨ç¤º $0,1,2\cdots,q-2,q-1$ï¼Œå®šä¹‰ $X$ ä¸­çš„ä¹˜æ³•è¿ç®—ä¸º
$$
(a+b\sqrt 3)(c+d\sqrt 3)=(ac+3bd)\bmod q+(bc+ad)\bmod q\sqrt3
$$
$X$ ä¸­ä»»ä½•ä¸¤ä¸ªå…ƒç´ çš„ä¹˜ç§¯ä¸€å®šä¹Ÿåœ¨ $X$ å†…ï¼Œä½†å®ƒä¸æ˜¯ç¾¤ï¼Œå› ä¸ºä¸æ˜¯æ‰€æœ‰å…ƒç´ éƒ½å¯é€†ï¼Œåªä¿ç•™æœ‰é€†çš„å…ƒç´ ï¼Œå°±å¾—åˆ°äº†ç¾¤ $X^*$ã€‚å› ä¸º $(2+\sqrt 3)(2+(q-1)\sqrt 3)\equiv 1\pmod q$ï¼Œæ‰€ä»¥ $2+\sqrt 3\in X^{*}$ã€‚

è€ƒè™‘
$$
(2+\sqrt 3)^{2^{p-2}}+(2-\sqrt 3)^{2^{p-2}} \equiv 0\pmod {M_p}\\
(2+\sqrt 3)^{2^{p-1}}+[(2+\sqrt 3)(2-\sqrt 3)]^{2^{p-2}} \equiv 0\pmod {M_p}\\
(2+\sqrt 3)^{2^{p-1}}\equiv -1\pmod {M_p}
$$
è¿™è¯´æ˜äº† $2 + \sqrt 3$ çš„é˜¶ä¸º $2^p$ï¼Œå³ $(2 + \sqrt 3)^0,(2 + \sqrt 3)^1,(2 + \sqrt 3)^2,\cdots,(2+\sqrt 3)^{2^p-1}$ ä¸¤ä¸¤ä¸åŒã€‚

äºæ˜¯æœ‰ $2^p \le |X*| \le q^2 \le M_p$ï¼Œå¾—å‡ºçŸ›ç›¾ $2^p \le M_p$ï¼Œæ•… $M_p$ ä¸ºè´¨æ•°ã€‚

#### å¿…è¦æ€§

ç°åœ¨å·²çŸ¥ $M_p$ æ˜¯è´¨æ•°ï¼Œè¦è¯´æ˜ $M_p|(2+\sqrt 3)^{2^{p-2}}+(2-\sqrt 3)^{2^{p-2}}$ã€‚

å¯ä»¥å½’çº³è¯æ˜ï¼Œå¯¹äºå¥‡æ•° $p\ge 3$ï¼Œæœ‰ $2^p-1\equiv 7\pmod 8$ å’Œ $2^p-1\equiv 7\pmod {12}$ã€‚

å¯¹äºå¥‡è´¨æ•° $p$ï¼š

- $2^p-1\equiv 7\pmod 8\Rightarrow \left(\dfrac 2p\right)=1\Rightarrow 2^{\frac{M_p-1}2}\equiv 1\pmod {M_p}$
- $2^p-1\equiv 7\pmod {12}\Rightarrow \left(\dfrac 3p\right)=-1\Rightarrow 3^{\frac{M_p-1}2}\equiv -1\pmod {M_p}$

ç¬¬ä¸€æ­¥çš„åŸç†éƒ½æ˜¯äºŒæ¬¡äº’åå¾‹åŠå…¶è¡¥å……ï¼Œç¬¬äºŒæ­¥çš„åŸç†éƒ½æ˜¯æ¬§æ‹‰å‡†åˆ™ã€‚

åƒå‰é¢ä¸€æ ·ï¼Œå®šä¹‰ $X=\{a+b\sqrt 3|a,b\in\mathbb Z_{M_p}\}$ï¼Œä¿ç•™æœ‰é€†çš„å…ƒç´ å¾—åˆ°ç¾¤ $X^*$ã€‚

> å¼•ç†ï¼š$\forall x,y\in X^*,(x+y)^{M_p}\equiv x^{M_p}+y^{M_p}\pmod{M_p}$ã€‚

æ ¹æ® $M_p|\binom{M_p}i$ã€‚

é‚£ä¹ˆï¼Œæˆ‘ä»¬æœ‰ï¼š
$$
\begin{aligned}
(6+2\sqrt 3)^{M_p}&=6^{M_p}+2^{M_p}(\sqrt 3)^{M_p}\\
&=6+2\sqrt 3\cdot 3^{\frac{M_p-1}2}\\
&=6-2\sqrt 3
\end{aligned}
$$
ç”±äº $2+\sqrt 3=\frac{(6+2\sqrt 3)^2}{24}$ï¼Œè¿›ä¸€æ­¥
$$
\begin{aligned}
(2+\sqrt 3)^{\frac{M_p+1}2}&=\frac{(6+2\sqrt 3)^{M_p+1}}{24^{\frac{M_p+1}2}}\\
&=\frac{(6+2\sqrt 3)(6-2\sqrt 3)}{24\cdot (2^{\frac{M_p-1}2})^3\cdot 3^{\frac{M_p-1}2}}\\
&=-1
\end{aligned}
$$
æœ€åï¼Œåœ¨ä¸¤è¾¹åŒä¹˜ $(2-\sqrt 3)^{\frac{M_p+1}4}$ï¼Œå¹¶åˆ©ç”¨ $(2+\sqrt 3)(2-\sqrt 3)=1$
$$
\begin{aligned}
(2+\sqrt 3)^{\frac{M_p+1}2}(2-\sqrt 3)^{\frac{M_p+1}4}&=-(2-\sqrt 3)^{\frac{M_p+1}4}\\
(2+\sqrt 3)^{\frac{M_p+1}4}+(2-\sqrt 3)^{\frac{M_p+1}4}&=0\\
(2+\sqrt 3)^{2^{p-2}}+(2-\sqrt 3)^{2^{p-2}}&=0
\end{aligned}
$$

### å…³äºå‰ $k$ ä¸ªæ­£å¥‡æ•°ä¹˜ç§¯æ¨¡ $2^m$

> æ±‚ $2^n$ å†…æ‰€æœ‰å¥‡æ•°çš„ä¹˜ç§¯ $\bmod 2^n$ã€‚
>
> $n \le 10^4$

è®¾ $f_n=\prod_{i=1}^{2^{n-1}}2i-1\bmod 2^n$ï¼Œå¯¹äº $n\ge 2$ï¼Œæœ‰
$$
\begin{aligned}
f_{n+1}&=(\prod_{i=1}^{2^{n-1}}2i-1\bmod 2^{n+1})(\prod_{i=1}^{2^{n-1}}2i-1+2^n\bmod 2^{n+1})\bmod 2^{n+1}\\
&=(\prod_{i=1}^{2^{n-1}}2i-1\bmod 2^{n+1})^2\bmod 2^{n+1}\\
\end{aligned}
$$
è®¾ $\prod_{i=1}^{2^{n-1}}2i-1\bmod 2^{n+1}=f_n+k2^n(k\in\{0,1\})$ï¼Œç»§ç»­æ¨ã€‚
$$
\begin{aligned}
f_{n+1}&=(f_n+k2^n)^2\bmod 2^{n+1}\\
&=f_n^2+k2^{n+1}+k^22^{2n}\bmod 2^{n+1}\\
&=f_n^2\bmod 2^{n+1}
\end{aligned}
$$
è®¡ç®—å¹³æ–¹å¯ä»¥ç”¨ `FFT` åšåˆ° $O(n\log n)$ï¼Œæ€»å¤æ‚åº¦ $O(n^2\log n)$ã€‚

### ä¸€ä¸ªéå¸¸å›°éš¾çš„é—®é¢˜

> æ±‚ $\frac {p-1}2!\bmod p$ï¼Œ$p$ æ˜¯è´¨æ•°ä¸” $p\equiv 3\pmod 4$ã€‚
>
> $p \le ???$

å¿«é€Ÿé˜¶ä¹˜ç®—æ³• $O(\sqrt p\log p)$ã€‚

å…¶ä»–åšæ³•ï¼šæ ¹æ® Wilson å®šç†ï¼Œ$(p-1)!\equiv -1\pmod p$ï¼Œé‚£ä¹ˆ $\frac {p-1}2!\equiv \pm 1\pmod p$ã€‚å‡†ç¡®åœ°ï¼Œ$\frac {p-1}2!\equiv 1\pmod p$ å½“ä¸”ä»…å½“ä»¥ä¸‹ä¹‹ä¸€æˆç«‹ï¼š

- $p\equiv 3\pmod 8 \land h(-p)\equiv 1\pmod 4$

- $p\equiv 7\pmod 8\land h(-p)\equiv 3\pmod 4$

$h(-p) \bmod 4$ æ€ä¹ˆå¿«é€Ÿç®—ï¼Ÿä¸ä¼šã€‚
